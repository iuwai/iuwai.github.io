<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Iuwai</title>
  
  <subtitle>学如逆水行舟，不进则退。</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iuwai.com/"/>
  <updated>2018-03-25T02:24:08.591Z</updated>
  <id>http://www.iuwai.com/</id>
  
  <author>
    <name>Iuwai</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>xiaochao</title>
    <link href="http://www.iuwai.com/2018/03/25/xiaochao/"/>
    <id>http://www.iuwai.com/2018/03/25/xiaochao/</id>
    <published>2018-03-25T02:11:28.000Z</published>
    <updated>2018-03-25T02:24:08.591Z</updated>
    
    <content type="html"><![CDATA[<p>日常小小抄<br><a id="more"></a></p><h4 id="2018-03-25-10-15"><a href="#2018-03-25-10-15" class="headerlink" title="2018.03.25 10:15"></a>2018.03.25 10:15</h4><p>知世故而不世故，才是真正的少年。<br>被伤害过依然能倾心以赴赤诚相待，才是真正的少年。</p><hr><p>网上曾经流传一句话“中年男人不如狗”。<br>说得有理有据：</p><p>1.年龄逐渐增长，身体机能随之下降，多种病症出现。</p><p>2.他们在家中承担起抚养父母妻儿的责任，在社会上如果没有体面的工作就要忍气吞声。天能塌，他们不能。</p><p>3.男人年轻的时候都想着仗剑走天涯，惦记着诗和远方，后来工作太忙钱不够就没去。</p><p>4.生而为人，无法避免被“比较”。从小到大向来如此，小时候的敌人是别人家的孩子，长大之后是别人家的丈夫，再往后是别人家的父亲。</p><hr><p>知乎上也有这样一个问题：</p><p>“为什么那么多男人开车回家，到了楼下还要在车里坐好久？”</p><p>有一个回答获得了高分点赞：</p><p>“很多时候我也不想下车，因为那是一个分界点。在车上，一个人静一静，抽根烟，发会呆这个躯体属于自己；但推开车门，你就是柴米油盐，是父亲、是儿子、是老公，唯独不是你自己。我们把真实的自己藏在车里；打开车门出去，哪怕是哭着爬着，也只能把被人寄予厚望的身份扮演下去。”</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;日常小小抄&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Django-route</title>
    <link href="http://www.iuwai.com/2018/03/10/Django-route/"/>
    <id>http://www.iuwai.com/2018/03/10/Django-route/</id>
    <published>2018-03-10T08:24:29.000Z</published>
    <updated>2018-04-02T05:34:33.145Z</updated>
    
    <content type="html"><![CDATA[<p>Django路由系统:动态路由、指定参数名、默认参数<br><a id="more"></a></p><h2 id="Django路由系统"><a href="#Django路由系统" class="headerlink" title="Django路由系统"></a>Django路由系统</h2><h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><p>urls.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> patterns, include,url</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> web.views <span class="keyword">import</span> index, login, list</span><br><span class="line">urlpatterns = patterns(<span class="string">''</span>,</span><br><span class="line">    url(<span class="string">r'^list/(\d*)/$'</span>, list),  <span class="comment">#一个参数</span></span><br><span class="line">    url(<span class="string">r'^list/(\d*)/(\d*)/$'</span>, list),  <span class="comment">#两个参数，按顺序获取</span></span><br><span class="line">    url(<span class="string">r'^list/(?P&lt;name&gt;\d*)/(?P&lt;id&gt;\d*)/$'</span>, list),  <span class="comment">#指定参数名,获取参数时名字必须为name, id</span></span><br><span class="line">    url(<span class="string">r'^list/(?P&lt;name&gt;\d*)/$'</span>, list, &#123;<span class="string">'id'</span>:<span class="number">222</span>&#125;),  <span class="comment">#默认参数值</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>views.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(request, id1, id2)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> id</span><br><span class="line">    <span class="keyword">print</span> id1, id2</span><br><span class="line">    <span class="keyword">return</span> HttpResponse()</span><br></pre></td></tr></table></figure></p><p>指定参数名：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(request, id, name)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> name, id</span><br><span class="line">    <span class="keyword">return</span> HttpResponse()</span><br></pre></td></tr></table></figure></p><p>请求链接：<a href="http://localhost:9000/list/100" target="_blank" rel="noopener">http://localhost:9000/list/100</a>         #一个参数<br>请求链接：<a href="http://localhost:9000/list/100/1000" target="_blank" rel="noopener">http://localhost:9000/list/100/1000</a>    #两个参数<br>注：请求链接最后必须要加/,如果不加，urls配置中必须要加上终止符：/$,这样请求时会自动加上/</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Django路由系统:动态路由、指定参数名、默认参数&lt;br&gt;
    
    </summary>
    
      <category term="Python" scheme="http://www.iuwai.com/categories/Python/"/>
    
    
      <category term="路由系统" scheme="http://www.iuwai.com/tags/%E8%B7%AF%E7%94%B1%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>OpenSSH Update</title>
    <link href="http://www.iuwai.com/2018/02/09/OpenSSH-Update/"/>
    <id>http://www.iuwai.com/2018/02/09/OpenSSH-Update/</id>
    <published>2018-02-09T07:37:17.000Z</published>
    <updated>2018-04-02T05:31:20.762Z</updated>
    
    <content type="html"><![CDATA[<p>由于公司安全需要，OpenSSH要加固，需升级至当前最新版本OpenSSH_7.6p1<br>环境：CentOS6.8 x64<br><a id="more"></a></p><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="下载相关软件包"><a href="#下载相关软件包" class="headerlink" title="下载相关软件包"></a>下载相关软件包</h2><p>OpenSSH需要依赖ZLIB和OpenSSL，因此需要从官网下载三者的源码包。需要注意的是：OpenSSH最新版7.4p1依赖的OpenSSL版本为1.0.2k，而不是其最新版1.1.0e（使用此版会升级失败）,ZLIB可以使用最新版1.2.11。CentOS6.8自带的zlib版本为1.2.3，也可不进行升级。 三者源码下载地址：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://www.zlib.net/</span><br><span class="line">http://www.openssl.org/</span><br><span class="line">http://www.openssh.org/</span><br></pre></td></tr></table></figure></p><p>或者使用我准备好的包：<br><a href="https://pan.baidu.com/s/1PzuK3FGVPLZuWvVvqJgaIQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1PzuK3FGVPLZuWvVvqJgaIQ</a></p><h2 id="查看系统当前软件版本"><a href="#查看系统当前软件版本" class="headerlink" title="查看系统当前软件版本"></a>查看系统当前软件版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -q zlib</span><br><span class="line">openssl version</span><br><span class="line">ssh -V</span><br></pre></td></tr></table></figure><h2 id="安装telnet服务并启用"><a href="#安装telnet服务并启用" class="headerlink" title="安装telnet服务并启用"></a>安装telnet服务并启用</h2><p>因升级OpenSSH过程中需要卸载现有OpenSSH, 因此为了保持服务器的远程连接可用，需要启用telnet服务作为替代，如升级出现问题，也可通过telnet登录服务器进行回退。</p><h3 id="A、安装telnet服务"><a href="#A、安装telnet服务" class="headerlink" title="A、安装telnet服务"></a>A、安装telnet服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install telnet-server*</span><br></pre></td></tr></table></figure><h3 id="B、启用telnet"><a href="#B、启用telnet" class="headerlink" title="B、启用telnet"></a>B、启用telnet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">先关闭防火墙，否则telnet可能无法连接</span><br><span class="line">service iptables stop</span><br><span class="line">chkconfig iptables off</span><br><span class="line">vi /etc/xinetd.d/telnet                 <span class="comment">#将其中disable字段的yes改为no以启用telnet服务</span></span><br><span class="line">mv /etc/securetty /etc/securetty.old    <span class="comment">#允许root用户通过telnet登录</span></span><br><span class="line">service xinetd start                    <span class="comment">#启动telnet服务</span></span><br><span class="line">chkconfig xinetd on                     <span class="comment">#使telnet服务开机启动，避免升级过程中服务器意外重启后无法远程登录系统</span></span><br><span class="line">telnet [ip]                             <span class="comment">#新开启一个远程终端以telnet登录验证是否成功启用</span></span><br></pre></td></tr></table></figure><h2 id="安装编译所需工具包"><a href="#安装编译所需工具包" class="headerlink" title="安装编译所需工具包"></a>安装编译所需工具包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc pam-devel zlib-devel</span><br></pre></td></tr></table></figure><h1 id="正式升级"><a href="#正式升级" class="headerlink" title="正式升级"></a>正式升级</h1><h2 id="升级ZLIB"><a href="#升级ZLIB" class="headerlink" title="升级ZLIB"></a>升级ZLIB</h2><h3 id="A、解压zlib-1-2-11源码并编译"><a href="#A、解压zlib-1-2-11源码并编译" class="headerlink" title="A、解压zlib_1.2.11源码并编译"></a>A、解压zlib_1.2.11源码并编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf zlib-1.2.11.tar.gz</span><br><span class="line"><span class="built_in">cd</span> zlib-1.2.11</span><br><span class="line">CFLAGS=<span class="string">'-mstackrealign -fPIC -O3'</span> ./configure --prefix=/usr     //如果不加【CFLAGS=<span class="string">'-mstackrealign -fPIC -O3'</span>】这一段配置后面安装OpenSSH时会报错。</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="B、卸载当前zlib"><a href="#B、卸载当前zlib" class="headerlink" title="B、卸载当前zlib"></a>B、卸载当前zlib</h3><p>注意：此步骤必须在步骤A执行完毕后再执行，否则先卸载zlib后，/lib64/目录下的zlib相关库文件会被删除，步骤A编译zlib会失败。（补救措施：从其他相同系统的服务器上复制/lib64、/usr/lib和/usr/lib64目录下的libcrypto.so.10、libssl.so.10、libz.so.1、libz.so.1.2.3四个文件到相应目录即可。可通过whereis、locate或find命令找到这些文件的位置）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps zlib</span><br></pre></td></tr></table></figure><h3 id="C、安装之前编译好的zlib"><a href="#C、安装之前编译好的zlib" class="headerlink" title="C、安装之前编译好的zlib"></a>C、安装之前编译好的zlib</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在zlib编译目录执行如下命令</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="D、共享库注册"><a href="#D、共享库注册" class="headerlink" title="D、共享库注册"></a>D、共享库注册</h3><p>zlib安装完成后，会在/usr/lib目录中生产zlib相关库文件，需要将这些共享库文件注册到系统中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'/usr/lib'</span> &gt;&gt; /etc/ld.so.conf</span><br><span class="line">ldconfig                    <span class="comment">#更新共享库cache</span></span><br></pre></td></tr></table></figure></p><p><strong>或者</strong>采用如下方式也可<font color="#FF6600">(建议用这种方式)</font>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ln -s  /usr/lib/libz.so.1 libz.so.1.2.11</span><br><span class="line">ln -s  /usr/lib/libz.so libz.so.1.2.11</span><br><span class="line">ln -s  /usr/lib/libz.so.1 /lib/libz.so.1</span><br><span class="line">rm -f /usr/lib64/libz.so                                  //若没有删除,则openssl编译失败.</span><br><span class="line">ln -s  /usr/lib/libz.so /usr/lib64/libz.so</span><br><span class="line">ln -s  /usr/lib64/libz.so ../../lib64/libz.so.1.2.11   //64位系统必须修改这个</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure></p><h2 id="升级OpenSSL"><a href="#升级OpenSSL" class="headerlink" title="升级OpenSSL"></a>升级OpenSSL</h2><p>官方升级文档：<a href="http://www.linuxfromscratch.org/blfs/view/cvs/postlfs/openssl.html" target="_blank" rel="noopener">http://www.linuxfromscratch.org/blfs/view/cvs/postlfs/openssl.html</a></p><h3 id="A、备份当前openssl"><a href="#A、备份当前openssl" class="headerlink" title="A、备份当前openssl"></a>A、备份当前openssl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">find / -name openssl</span><br><span class="line">/etc/pki/ca-trust/extracted/openssl</span><br><span class="line">/usr/bin/openssl</span><br><span class="line">/usr/lib64/openssl</span><br><span class="line">/usr/include/openssl</span><br><span class="line"></span><br><span class="line">mv /usr/lib64/openssl /usr/lib64/openssl.old</span><br><span class="line">mv /usr/bin/openssl  /usr/bin/openssl.old</span><br><span class="line">mv /etc/pki/ca-trust/extracted/openssl  /etc/pki/ca-trust/extracted/openssl.old</span><br><span class="line">mv /usr/include/openssl /usr/include/openssl.old</span><br></pre></td></tr></table></figure><p>如下两个库文件必须先备份，因系统内部分工具（如yum、wget等）依赖此库，而新版OpenSSL不包含这两个库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/lib64/libcrypto.so.10  /usr/lib64/libcrypto.so.10.old</span><br><span class="line">cp /usr/lib64/libssl.so.10  /usr/lib64/libssl.so.10.old</span><br></pre></td></tr></table></figure></p><h3 id="B、卸载当前openssl"><a href="#B、卸载当前openssl" class="headerlink" title="B、卸载当前openssl"></a>B、卸载当前openssl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep openssl</span><br><span class="line">openssl-1.0.1e-42.el6.x86_64</span><br><span class="line"></span><br><span class="line">rpm -e --nodeps openssl-1.0.1e-42.el6.x86_64</span><br><span class="line">rpm -qa | grep openssl</span><br><span class="line"><span class="comment">#或者直接执行此命令：</span></span><br><span class="line">rpm -qa |grep openssl|xargs -i rpm -e --nodeps &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="C、解压openssl-1-0-2k源码并编译安装"><a href="#C、解压openssl-1-0-2k源码并编译安装" class="headerlink" title="C、解压openssl_1.0.2k源码并编译安装"></a>C、解压openssl_1.0.2k源码并编译安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf openssl-1.0.2k.tar.gz</span><br><span class="line"><span class="built_in">cd</span> openssl-1.0.2k</span><br><span class="line">./config --prefix=/usr --openssldir=/etc/ssl --shared zlib    <span class="comment">#必须加上--shared，否则编译时会找不到新安装的openssl的库而报错</span></span><br><span class="line">make</span><br><span class="line">make <span class="built_in">test</span>                            <span class="comment">#必须执行这一步结果为pass才能继续，否则即使安装完成，ssh也无法使用</span></span><br><span class="line">make install</span><br><span class="line">openssl version -a                   <span class="comment">#查看是否升级成功</span></span><br></pre></td></tr></table></figure><p>make test正确输出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">*---- START OF RECORD ----</span><br><span class="line">** Record Content-type: 22</span><br><span class="line">** Record Version: fefd</span><br><span class="line">** Record Epoch: 1</span><br><span class="line">** Record Sequence: 000000000000</span><br><span class="line">** Record Length: 64</span><br><span class="line">**---- START OF HANDSHAKE MESSAGE FRAGMENT ----</span><br><span class="line">**---- HANDSHAKE MESSAGE FRAGMENT ENCRYPTED ----</span><br><span class="line">*---- END OF RECORD ----</span><br><span class="line">---- END OF PACKET ----</span><br><span class="line">PASS</span><br><span class="line">test_bad_dtls</span><br><span class="line">../util/shlib_wrap.sh ./bad_dtls_test</span><br><span class="line">make[1]: Leaving directory `/tmp/openssl-1.0.2m/<span class="built_in">test</span><span class="string">'</span></span><br><span class="line"><span class="string">OPENSSL_CONF=apps/openssl.cnf util/opensslwrap.sh version -a</span></span><br><span class="line"><span class="string">OpenSSL 1.0.2m  2 Nov 2017</span></span><br><span class="line"><span class="string">built on: reproducible build, date unspecified</span></span><br><span class="line"><span class="string">platform: linux-x86_64</span></span><br><span class="line"><span class="string">options:  bn(64,64) rc4(16x,int) des(idx,cisc,16,int) idea(int) blowfish(idx)</span></span><br><span class="line"><span class="string">compiler: gcc -I. -I.. -I../include  -fPIC -DOPENSSL_PIC -DZLIB -DOPENSSL_THREADS -D_REENTRANT -DDSO_DLFCN -DHAVE_DLFCN_H -Wa,--noexecstack -m64 -DL_ENDIAN -O3 -Wall -DOPENSSL_IA32_SSE2 -            </span></span><br><span class="line"><span class="string">DOPENSSL_BN_ASM_MONT -DOPENSSL_BN_ASM_MONT5 -DOPENSSL_BN_ASM_GF2m -DRC4_ASM -DSHA1_ASM -DSHA256_ASM -    </span></span><br><span class="line"><span class="string">DSHA512_ASM -DMD5_ASM -DAES_ASM -DVPAES_ASM -DBSAES_ASM -DWHIRLPOOL_ASM -DGHASH_ASM -DECP_NISTZ256_ASM</span></span><br><span class="line"><span class="string">OPENSSLDIR: "/etc/ssl"</span></span><br></pre></td></tr></table></figure></p><h3 id="D、恢复共享库"><a href="#D、恢复共享库" class="headerlink" title="D、恢复共享库"></a>D、恢复共享库</h3><p>由于OpenSSL_1.0.2k不提供libcrypto.so.10和libssl.so.10这两个库，而yum、wget等工具又依赖此库，因此需要将先前备份的这两个库进行恢复，其他的可视情况考虑是否恢复。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/lib64/libcrypto.so.10.old  /usr/lib64/libcrypto.so.10</span><br><span class="line">mv /usr/lib64/libssl.so.10.old  /usr/lib64/libssl.so.10</span><br></pre></td></tr></table></figure></p><p>返回值：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mv  /usr/lib64/libcrypto.so.10.old  /usr/lib64/libcrypto.so.10</span><br><span class="line">mv: overwrite `/usr/lib64/libcrypto.so.10<span class="string">'? y</span></span><br><span class="line"><span class="string">mv  /usr/lib64/libssl.so.10.old  /usr/lib64/libssl.so.10</span></span><br><span class="line"><span class="string">mv: overwrite `/usr/lib64/libssl.so.10'</span>? y</span><br></pre></td></tr></table></figure></p><h2 id="升级OpenSSH"><a href="#升级OpenSSH" class="headerlink" title="升级OpenSSH"></a>升级OpenSSH</h2><p>官方升级文档：<a href="http://www.linuxfromscratch.org/blfs/view/svn/postlfs/openssh.html" target="_blank" rel="noopener">http://www.linuxfromscratch.org/blfs/view/svn/postlfs/openssh.html</a></p><h3 id="A、备份当前openssh"><a href="#A、备份当前openssh" class="headerlink" title="A、备份当前openssh"></a>A、备份当前openssh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/ssh /etc/ssh.old</span><br></pre></td></tr></table></figure><h3 id="B、卸载当前openssh"><a href="#B、卸载当前openssh" class="headerlink" title="B、卸载当前openssh"></a>B、卸载当前openssh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep openssh</span><br><span class="line">openssh-clients-5.3p1-111.el6.x86_64</span><br><span class="line">openssh-server-5.3p1-111.el6.x86_64</span><br><span class="line">openssh-5.3p1-111.el6.x86_64</span><br><span class="line">openssh-askpass-5.3p1-111.el6.x86_64</span><br><span class="line"></span><br><span class="line">rpm -e --nodeps openssh-5.3p1-111.el6.x86_64</span><br><span class="line">rpm -e --nodeps openssh-server-5.3p1-111.el6.x86_64</span><br><span class="line">rpm -e --nodeps openssh-clients-5.3p1-111.el6.x86_64</span><br><span class="line">rpm -e --nodeps openssh-askpass-5.3p1-111.el6.x86_64</span><br><span class="line">rpm -qa | grep openssh</span><br><span class="line"><span class="comment">#或者直接执行此命令：</span></span><br><span class="line">rpm -qa |grep openssh|xargs -i rpm -e --nodeps &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="C、openssh安装前环境配置"><a href="#C、openssh安装前环境配置" class="headerlink" title="C、openssh安装前环境配置"></a>C、openssh安装前环境配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">install  -v -m700 -d /var/lib/sshd</span><br><span class="line">chown  -v root:sys /var/lib/sshd</span><br><span class="line">groupadd -g 50 sshd</span><br><span class="line">useradd  -c <span class="string">'sshd PrivSep'</span> -d /var/lib/sshd -g sshd -s /bin/<span class="literal">false</span> -u 50 sshd</span><br></pre></td></tr></table></figure><h3 id="D、解压openssh-7-4p1源码并编译安装"><a href="#D、解压openssh-7-4p1源码并编译安装" class="headerlink" title="D、解压openssh_7.4p1源码并编译安装"></a>D、解压openssh_7.4p1源码并编译安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf openssh-7.4p1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> openssh-7.4p1</span><br><span class="line">./configure --prefix=/usr  --sysconfdir=/etc/ssh  --with-md5-passwords  --with-pam  --with-zlib --with-openssl-includes=/usr --with-privsep-path=/var/lib/sshd</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="E、openssh安装后环境配置"><a href="#E、openssh安装后环境配置" class="headerlink" title="E、openssh安装后环境配置"></a>E、openssh安装后环境配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在openssh编译目录执行如下命令</span></span><br><span class="line">install -v -m755    contrib/ssh-copy-id /usr/bin</span><br><span class="line">install -v -m644    contrib/ssh-copy-id.1 /usr/share/man/man1</span><br><span class="line">install -v -m755 -d /usr/share/doc/openssh-7.4p1</span><br><span class="line">install -v -m644    INSTALL LICENCE OVERVIEW README* /usr/share/doc/openssh-7.4p1</span><br><span class="line">ssh -V              <span class="comment">#验证是否升级成功</span></span><br></pre></td></tr></table></figure><h3 id="F、启用OpenSSH服务"><a href="#F、启用OpenSSH服务" class="headerlink" title="F、启用OpenSSH服务"></a>F、启用OpenSSH服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在openssh编译目录执行如下目录</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'X11Forwarding yes'</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"PermitRootLogin yes"</span> &gt;&gt; /etc/ssh/sshd_config   <span class="comment">#允许root用户通过ssh登录</span></span><br><span class="line">cp -p contrib/redhat/sshd.init /etc/init.d/sshd</span><br><span class="line">chmod +x /etc/init.d/sshd</span><br><span class="line">chkconfig  --add  sshd</span><br><span class="line">chkconfig  sshd  on</span><br><span class="line">chkconfig  --list  sshd</span><br><span class="line">service sshd restart</span><br></pre></td></tr></table></figure><p>注意：如果升级操作一直是在ssh远程会话中进行的，上述sshd服务重启命令可能导致会话断开并无法使用ssh再行登入（即ssh未能成功重启），此时需要通过telnet登入再执行sshd服务重启命令。</p><h3 id="G、修改文件-etc-ssh-sshd-config"><a href="#G、修改文件-etc-ssh-sshd-config" class="headerlink" title="G、修改文件/etc/ssh/sshd_config"></a>G、修改文件/etc/ssh/sshd_config</h3><p>由于加固后的ssh（ssh6.7以上）屏蔽了不安全算法，需要在/etc/ssh/sshd_config最后加上如下信息，不然Python模块paromiko，无法连接加固后的机器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1</span><br></pre></td></tr></table></figure></p><h2 id="善后工作"><a href="#善后工作" class="headerlink" title="善后工作"></a>善后工作</h2><p>新开启远程终端以ssh [ip]登录系统，确认一切正常升级成功后，只需关闭telnet服务以保证系统安全性即可。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/securetty.old /etc/securetty</span><br><span class="line">chkconfig  xinetd off</span><br><span class="line">service xinetd stop</span><br></pre></td></tr></table></figure></p><p>如有必要，可重新开启防火墙<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service iptables start</span><br><span class="line">chkconfig iptables on</span><br></pre></td></tr></table></figure></p><p>如需还原之前的ssh配置信息，可直接删除升级后的配置信息，恢复备份。<br>ssh大版本升级尽量不要删除新生成的ssh文件，将原文件与新生成文件都保留一份。<br>原版本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -V</span><br><span class="line">OpenSSH_5.3p1, OpenSSL 1.0.1e-fips 11 Feb 2013</span><br></pre></td></tr></table></figure></p><p>升级至：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OpenSSH_7.4p1, OpenSSL 1.0.2n  7 Dec 2017</span><br></pre></td></tr></table></figure></p><p><font color="#FF6600">后如果执行以下操作，会导致无法登陆。</font></p><p><font color="#FF6600">正确做法：使用此次安装好的文件/etc/ssh，不要用原文件覆盖！不然ssh无法使用。</font><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /etc/ssh</span><br><span class="line">mv /etc/ssh.old /etc/ssh</span><br></pre></td></tr></table></figure></p><h2 id="遇到的错误-1："><a href="#遇到的错误-1：" class="headerlink" title="遇到的错误-1："></a>遇到的错误-1：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">make[2]: Entering directory `/tmp/openssl-1.0.2m<span class="string">'</span></span><br><span class="line"><span class="string">[ -z "" ] || gcc -fPIC -DOPENSSL_PIC -DZLIB -DOPENSSL_THREADS -D_REENTRANT -DDSO_DLFCN -DHAVE_DLFCN_H -Wa,--noexecstack -m64 -DL_ENDIAN -O3 -Wall -DOPENSSL_IA32_SSE2 -DOPENSSL_BN_ASM_MONT -DOPENSSL_BN_ASM_MONT5 -DOPENSSL_BN_ASM_GF2m -DRC4_ASM -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DMD5_ASM -DAES_ASM -DVPAES_ASM -DBSAES_ASM -DWHIRLPOOL_ASM -DGHASH_ASM -DECP_NISTZ256_ASM -Iinclude \</span></span><br><span class="line"><span class="string">            -DFINGERPRINT_PREMAIN_DSO_LOAD -o fips_premain_dso  \</span></span><br><span class="line"><span class="string">            fips_premain.c fipscanister.o \</span></span><br><span class="line"><span class="string">            libcrypto.a -ldl -lz</span></span><br><span class="line"><span class="string">make[3]: Entering directory `/tmp/openssl-1.0.2m'</span></span><br><span class="line">make[4]: Entering directory `/tmp/openssl-1.0.2m<span class="string">'</span></span><br><span class="line"><span class="string">/usr/bin/ld: /usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/libz.a(deflate.o): relocation R_X86_64_32S against `_length_code'</span> can not be used when making a shared object; recompile with -fPIC</span><br><span class="line">/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/libz.a: could not <span class="built_in">read</span> symbols: Bad value</span><br><span class="line">collect2: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line">make[4]: *** [link_a.gnu] Error 1</span><br><span class="line">make[4]: Leaving directory `/tmp/openssl-1.0.2m<span class="string">'</span></span><br><span class="line"><span class="string">make[3]: *** [do_linux-shared] Error 2</span></span><br><span class="line"><span class="string">make[3]: Leaving directory `/tmp/openssl-1.0.2m'</span></span><br><span class="line">make[2]: *** [libcrypto.so.1.0.0] Error 2</span><br><span class="line">make[2]: Leaving directory `/tmp/openssl-1.0.2m<span class="string">'</span></span><br><span class="line"><span class="string">make[1]: *** [shared] Error 2</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `/tmp/openssl-1.0.2m/crypto'</span></span><br><span class="line">make: *** [build_crypto] Error 1</span><br></pre></td></tr></table></figure><p>解决办法：zlib编译时添加configure前面的配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFLAGS=<span class="string">'-mstackrealign -fPIC -O3'</span> ./configure --prefix=/usr</span><br></pre></td></tr></table></figure></p><h2 id="遇到的报错-2："><a href="#遇到的报错-2：" class="headerlink" title="遇到的报错-2："></a>遇到的报错-2：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">make[2]: Entering directory `/tmp/openssl-1.0.2m<span class="string">'</span></span><br><span class="line"><span class="string">[ -z "" ] || gcc -fPIC -DOPENSSL_PIC -DZLIB -DOPENSSL_THREADS -D_REENTRANT -DDSO_DLFCN -DHAVE_DLFCN_H -Wa,--noexecstack -m64 -DL_ENDIAN -O3 -Wall -DOPENSSL_IA32_SSE2 -DOPENSSL_BN_ASM_MONT -        DOPENSSL_BN_ASM_MONT5 -DOPENSSL_BN_ASM_GF2m -DRC4_ASM -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DMD5_ASM -    DAES_ASM -DVPAES_ASM -DBSAES_ASM -DWHIRLPOOL_ASM -DGHASH_ASM -DECP_NISTZ256_ASM -Iinclude \</span></span><br><span class="line"><span class="string">            -DFINGERPRINT_PREMAIN_DSO_LOAD -o fips_premain_dso  \</span></span><br><span class="line"><span class="string">            fips_premain.c fipscanister.o \</span></span><br><span class="line"><span class="string">            libcrypto.a -ldl -lz</span></span><br><span class="line"><span class="string">make[3]: Entering directory `/tmp/openssl-1.0.2m'</span></span><br><span class="line">make[4]: Entering directory `/tmp/openssl-1.0.2m<span class="string">'</span></span><br><span class="line"><span class="string">/usr/bin/ld: error while loading shared libraries: libz.so.1: cannot open shared object file: No such file or directory</span></span><br><span class="line"><span class="string">collect2: ld returned 127 exit status</span></span><br><span class="line"><span class="string">make[4]: *** [link_a.gnu] Error 1</span></span><br><span class="line"><span class="string">make[4]: Leaving directory `/tmp/openssl-1.0.2m'</span></span><br><span class="line">make[3]: *** [do_linux-shared] Error 2</span><br><span class="line">make[3]: Leaving directory `/tmp/openssl-1.0.2m<span class="string">'</span></span><br><span class="line"><span class="string">make[2]: *** [libcrypto.so.1.0.0] Error 2</span></span><br><span class="line"><span class="string">make[2]: Leaving directory `/tmp/openssl-1.0.2m'</span></span><br><span class="line">make[1]: *** [shared] Error 2</span><br><span class="line">make[1]: Leaving directory `/tmp/openssl-1.0.2m/crypto<span class="string">'</span></span><br><span class="line"><span class="string">make: *** [build_crypto] Error 1</span></span><br></pre></td></tr></table></figure><p>解决办法：<br>仔细检查提示路径下的libz.so文件是否正确。</p><h2 id="遇到的报错-3："><a href="#遇到的报错-3：" class="headerlink" title="遇到的报错-3："></a>遇到的报错-3：</h2><p>现象：<br>用Python写的脚本调用到paramiko模块，模块ssh连接加固后的机器失败，报无法连接，但secureCRT可以连接。<br>运行paromiko连接远程服务器失败：FAIL : SSHException: Incompatible ssh peer (no acceptable kex algorithm)<br>原因：<br>因为ssh6.7以上屏蔽不安全算法导致。<br>解决：<br>在/etc/ssh/sshd_config最后加上：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1</span><br></pre></td></tr></table></figure></p><p>重启sshd服务，问题解决。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;由于公司安全需要，OpenSSH要加固，需升级至当前最新版本OpenSSH_7.6p1&lt;br&gt;环境：CentOS6.8 x64&lt;br&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://www.iuwai.com/categories/Linux/"/>
    
    
      <category term="安全加固" scheme="http://www.iuwai.com/tags/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"/>
    
      <category term="OpenSSH" scheme="http://www.iuwai.com/tags/OpenSSH/"/>
    
  </entry>
  
</feed>
